package com.qa.Utils;

import java.io.File;
import java.io.FileInputStream;
import java.io.FileNotFoundException;
import java.io.IOException;
import java.io.StringReader;
import java.net.MalformedURLException;
import java.net.URL;
import java.time.Duration;
import java.util.Properties;

import org.apache.commons.io.FileUtils;

import io.appium.java_client.android.AndroidDriver;
import io.appium.java_client.android.options.UiAutomator2Options;
import io.appium.java_client.service.local.AppiumDriverLocalService;
import io.appium.java_client.service.local.AppiumServiceBuilder;
import lombok.SneakyThrows;


public class AndroidUtils {

	AndroidDriver driver;
	AppiumDriverLocalService service;
	FileInputStream fis;
	Properties prop;
	FileUtils fileUtils;
	
	String fileSeparator = File.separator;
	String configFilePath = "C:\\Raj Setup\\Mobile_Automation\\2024_AppiumFramework\\src\\test\\resource\\TestData\\config.properties".replace("\\", fileSeparator);
	String chromeDriverPath = "C:\\Raj Setup\\ChromeDriver\\V 131\\chromedriver-win64\\chromedriver.exe".replace("\\", fileSeparator);
	String mainJSPath= "C:\\Users\\SHRUTI\\AppData\\Roaming\\npm\\node_modules\\appium\\build\\lib\\main.js".replace("\\", fileSeparator);
	String nodeJSPath = "C:\\Program Files\\nodejs\\node.exe".replace("\\", fileSeparator);;
	String apkFile= "C:\\Raj Setup\\Mobile_Automation\\2024_Appium\\src\\test\\resource\\General-Store.apk".replace("\\", fileSeparator);
	String ipAddress;
	String port;
	
	
	public AndroidUtils(AndroidDriver driver) {
		this.driver=driver;
		prop = new Properties();
	}
	
	@SneakyThrows
	public void initConfigProperties() {
			fis = new FileInputStream(configFilePath);
			prop.load(fis);
			ipAddress = prop.getProperty("ipAddress");
			System.out.println("Ip Address is : "+ipAddress);
			port = prop.getProperty("port");
			System.out.println("Running Port is : "+port);
	}
	
	@SneakyThrows
	public void initConfigProperties2() {
	    // Read the file content as a string using FileUtils
	    String configContent = FileUtils.readFileToString(new File(configFilePath), "UTF-8");

	    // Load the properties using StringReader
	    prop = new Properties();
	    prop.load(new StringReader(configContent));

	    // Retrieve property values
	    ipAddress = prop.getProperty("ipAddress");
	    System.out.println("IP Address is: " + ipAddress);

	    port = prop.getProperty("port");
	    System.out.println("Running Port is: " + port);
	}
	
	
	/**
	 * To start Appium server Automatically
	 */
	public void appiumServerConfiguration() {
		
//		initConfigProperties();
		initConfigProperties2();
		AppiumDriverLocalService service = new AppiumServiceBuilder()
				.withAppiumJS(new File(mainJSPath))
				.usingDriverExecutable(new File (nodeJSPath))
				.withIPAddress(ipAddress).usingPort(Integer.parseInt(port)).build();
				service.start();
	}
	
	/**
	 * To Initialize driver and apk file
	 * @return
	 */
	@SneakyThrows
	public AndroidDriver initDriver() {

//		appiumServerConfiguration();
		
//		initConfigProperties();
		initConfigProperties2();
		UiAutomator2Options options = new UiAutomator2Options();
		options.setDeviceName(prop.getProperty("deviceName"));
		System.setProperty("webdriver.chrome.driver", chromeDriverPath);
		options.setApp(apkFile);
			
		driver = new AndroidDriver(new URL("http://"+ipAddress+":"+port), options);
		implicitTimeout(10);
		return driver;
	}
	
	/**
	 * To Appium server automatically
	 */
		public void tearDownAppiumServer(){
			service.stop();
		}
		
		public AndroidDriver browserTearDown() {
//			tearDownAppiumServer();
			driver.quit();
			return driver;
		}
		
		/**
		 * Static wait - Thread.sleep
		 * @param value
		 */
		@SneakyThrows
		public void threadSleep(int value) {
				Thread.sleep(value);
		}
		
		/**
		 * To wait implicitly
		 * @param timeout
		 */
		public void implicitTimeout(int implicitTimeout) {
		driver.manage().timeouts().implicitlyWait(Duration.ofSeconds(implicitTimeout));
		}
		
		
		/**
		 * PageLoadTimeout
		 * @param pageLoadTimeout
		 */
		public void pageLoadTimeout(int pageLoadTimeout) {
		driver.manage().timeouts().pageLoadTimeout(Duration.ofSeconds(pageLoadTimeout));
		}
		
		
		
		
	
}
